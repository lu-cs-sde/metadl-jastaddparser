<project 
	name    = "JastAddParser" 
	default = "build" >

	<property name = "ASTPackage" value = "AST" />
	
	<taskdef 
		name      = "jflex" 
		classname = "JFlex.anttask.JFlexTask" 
		classpath = "tools/JFlex.jar" />
	
	<taskdef 
		name      = "beaver" 
		classname = "beaver.comp.run.AntTask" 
		classpath = "tools/beaver-ant.jar" />
	
	<taskdef 
		name      = "jastadd" 
		classname = "jastadd.JastAddTask" 
		classpath = "tools/jastadd2.jar" />

	
	<target name = "build" description = "Build JastAddParser">
		<mkdir dir = "src/parser"/>

		<jastadd 
			package = "${ASTPackage}" 
			rewrite = "true" 
			beaver  = "true"
			outdir  = "src"
			>
			
			<fileset dir = "parser" >
			<include name = "*.ast" />
			<include name = "*.jrag" />
			<include name = "*.jadd" />
			</fileset>
			
    	</jastadd>
		
		<jflex 
			file  = "parser/Grammar.flex" 
			outdir= "src/parser"
			nobak = "yes" />
		
		<java 
			fork      = "true"
			classpath = "tools/JastAddParser.jar" 
			classname = "Main" >
			<arg line = "parser/GrammarParser.jastadd parser/GrammarParser.beaver" />
		</java>

    	<beaver 
    		file          = "parser/GrammarParser.beaver"
    		destdir		  = "src/parser"
    		compress      = "no" 
    		useSwitch     = "yes"
    		terminalNames = "yes" />
		
		<mkdir  dir       = "bin" />
	    
    	<javac 
    		debug     = "true" 
    		srcdir    = "src" 
    		destdir   = "bin"
    		includes  = "**/*.java" />
		
	</target>
	
	
	<target 
		name    = "jar" 
		depends = "build" 
		 description = "Create runnable JastAddParser.jar" >
		
		<jar 
			destfile = "JastAddParser.jar" 
			basedir  = "bin" 
			includes = "**/*.class" 
			excludes = "Test*.class"
			
			compress = "false">
	 		
	 		<manifest>
	 		<attribute name = "Built-By" value = "${user.home}" />
        	<attribute name = "Main-Class" value = "Main" />
	 		</manifest>	
		</jar>
		
	</target>

	
	<target 
		name    = "source" 
		depends = "build"
		 description = "Create source jar" >
		
   		<jar destfile = "JastAddParser-src.jar" >
   			<fileset dir = "." >
   				<include name = "src/Main.java"/>
   				  <include name = "src/beaver/**/*.java"/>
   				<include name = "licenses/**/*" />
   				<include name = "parser/**/*"/>
   				<include name = "tools/**/*.jar"/>
   				<include name = "build.xml"/>
   			</fileset>
			<!--fileset dir = ".." >
				<include name = "JastAddParser/Main.java" />
				<include name = "JastAddParser/NameBinding.jrag" />
				<include name = "JastAddParser/Grammar.ast" />
				<include name = "JastAddParser/PrettyPrint.jrag" />
				<include name = "JastAddParser/ErrorCheck.jrag" />
				<include name = "JastAddParser/parser/GrammarParser.jastadd" />
				<include name = "JastAddParser/parser/Grammar.flex" />
				<include name = "JastAddParser/beaver/**/*.java" />
				<include name = "JastAddParser/tools/*.jar" />
				<include name = "JastAddParser/build.xml" />
				<include name = "JastAddParser/licences/BSD" />
				<include name = "JastAddParser/licences/CPL" />
				<include name = "JastAddParser/licences/GPL" />
				<include name = "JastAddParser/licences/LICENSE" />
      		</fileset-->
      		<manifest></manifest>
    	</jar>
		
	</target>
	
	
	<target 
		name    = "bootstrap" 
		depends = "jar" 
		description = "Bootstrap JastAddParser" >
		
		<echo>Copying the generated jar-file to directory tools</echo>
		<copy 
			file      = "JastAddParser.jar" 
			todir     = "tools/" 
			overwrite = "true" />
		
	</target>
	
	
	<target	name = "clean" description = "Remove generated files">
		
	    <delete file = "parser/GrammarParser.beaver" />
	    <delete dir = "src/parser" />
	    <delete dir = "src/${ASTPackage}" />
	    <delete file = "JastAddParser.jar" />
    	<delete dir = "bin"/>
    	<ant antfile="testcases/build.xml" inheritAll="false" target="clean"/>
	</target>
	
	<target name = "test" description="test JastAddParser" depends="jar,bootstrap">
		<ant antfile="testcases/build.xml" inheritAll="false"/>
	</target>

</project>
