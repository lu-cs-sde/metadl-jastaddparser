<project 
	name    = "JastAddParser" 
	default = "build" >

	<property name = "ASTPackage" value = "AST" />
	
	<taskdef 
		name      = "jflex" 
		classname = "JFlex.anttask.JFlexTask" 
		classpath = "tools/JFlex.jar" />
	
	<taskdef 
		name      = "beaver" 
		classname = "beaver.comp.run.AntTask" 
		classpath = "tools/beaver-ant.jar" />
	
	<taskdef 
		name      = "jastadd" 
		classname = "jastadd.JastAddTask" 
		classpath = "tools/jastadd2.jar" />

	
	<target name = "build" description = "Build JastAddParser">
		<mkdir dir = "src/parser"/>

		<jastadd 
			package = "${ASTPackage}" 
			rewrite = "true" 
			beaver  = "true"
			outdir  = "${basedir}/src"
			>
			
			<fileset dir = "parser" >
			<include name = "*.ast" />
			<include name = "*.jrag" />
			<include name = "*.jadd" />
			</fileset>
			
    	</jastadd>
		
		<jflex 
			file  = "parser/Grammar.flex" 
			outdir= "src/parser"
			nobak = "yes" />
		
		<java 
			fork      = "true"
			classpath = "tools/JastAddParser.jar" 
			classname = "Main" >
			<arg line = "parser/GrammarParser.jastadd parser/GrammarParser.beaver" />
		</java>

    	<beaver 
    		file          = "parser/GrammarParser.beaver"
    		destdir		  = "src/parser"
    		compress      = "no" 
    		useSwitch     = "yes"
    		terminalNames = "yes" />
		
		<mkdir  dir       = "bin" />
	    
    	<javac 
    		debug     = "true" 
    		srcdir    = "src" 
    		destdir   = "bin"
    		includes  = "**/*.java"
    		excludes  = "test/**/*.java" />
		
	</target>
	
	
	<target 
		name    = "jar" 
		depends = "build" 
		 description = "Create runnable JastAddParser.jar" >
		
		<jar 
			destfile = "JastAddParser.jar" 
			compress = "false">
			
			<fileset dir = "bin">
				<include name = "**/*.class"/>
				<exclude name = "test/**/*.class"/>
			</fileset>
			<fileset dir = ".">
				<include name = "properties/*"/>
			</fileset>
	 		
	 		<manifest>
	 			<attribute name = "Built-By" value = "${user.home}" />
        		<attribute name = "Main-Class" value = "Main" />
	 		</manifest>	
		</jar>
		
	</target>

	
	<target 
		name    = "source" 
        description = "Create source jar" >
		
   		<jar destfile = "JastAddParser-src.jar" >
			<fileset dir = ".">
				<include name = "src/Main.java"/>
   		        <include name = "src/beaver/**/*.java"/>
				<include name = "licenses/**/*" />
   				<include name = "parser/**/*"/>
				<include name = "properties/*"/>
   				<include name = "tools/**/*.jar"/>
   				<include name = "build.xml"/>
				<exclude name = "parser/*.beaver"/>
   			</fileset>
			<manifest></manifest>
    	</jar>
		
	</target>
	
	
	<target 
		name    = "bootstrap" 
		depends = "jar" 
		description = "Bootstrap JastAddParser" >
		
		<echo>Copying the generated jar-file to directory tools</echo>
		<copy 
			file      = "JastAddParser.jar" 
			todir     = "tools/" 
			overwrite = "true" />
		
	</target>
	
	
	<target	name = "clean" description = "Remove generated files">
		
	    <delete file = "parser/GrammarParser.beaver" />
	    <delete dir = "src/parser" />
	    <delete dir = "src/${ASTPackage}" />
	    <delete file = "JastAddParser.jar" />
		<delete file = "JastAddParser-src.jar" />
		<delete includeemptydirs="true">
			<fileset dir="bin" includes="**/*" excludes="test/*"/>
		</delete>
    	<ant antfile="testcases/build.xml" inheritAll="false" target="clean"/>
	</target>
	
	<target name = "release" description = "build a JastAddParser release" >
		<property file="properties/version.properties"/>
		<exec executable="git">
			<arg value="tag"/>
			<arg value="-a"/>
			<arg value="${version}"/>
			<arg value="-m"/>
			<arg value="Version ${version}"/>
		</exec>
		<antcall target="build-dist"/>
		<echo message="Release tag ${version} created for the latest (local) commit."/>
		<echo message="To push the any local commits:"/>
		<echo message="git push origin"/>
		<echo message="To push the release tag for version ${version}:"/>
		<echo message="git push origin ${version}"/>
	</target>
	
	<target name="build-dist" >
		<antcall target="jar"/>
		<antcall target="source"/>
		<echo message="Source and binary jar files created."/>
	</target>

</project>
